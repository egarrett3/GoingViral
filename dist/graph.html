<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/regenerator-runtime@0.13.1/runtime.js"></script>
    <!-- <script src='../src/graph.js'></script> -->
    <link rel="stylesheet" href="./main.css" />
    <title>Document</title>
</head>

<body>
    <div id='graph-bckgrnd'>
        <div id='graph'>
            
                <div id='scroll'>
                    <div class='state'>AL</div>
                    <div class='state'>AK</div> 
                    <div class='state'>AZ</div> 
                    <div class='state'>AR</div>
                    <div class='state'>CA</div> 
                    <div class='state'>CO</div> 
                    <div class='state'>CT</div> 
                    <div class='state'>DE</div> 
                    <div class='state'>FL</div> 
                    <div class='state'>GA</div> 
                    <div class='state'>HI</div> 
                    <div class='state'>ID</div> 
                    <div class='state'>IL</div> 
                    <div class='state'>IN</div> 
                    <div class='state'>IA</div> 
                    <div class='state'>KS</div> 
                    <div class='state'>KY</div> 
                    <div class='state'>LA</div> 
                    <div class='state'>ME</div> 
                    <div class='state'>MD</div> 
                    <div class='state'>MA</div> 
                    <div class='state'>MI</div> 
                    <div class='state'>MN</div> 
                    <div class='state'>MS</div> 
                    <div class='state'>MO</div> 
                    <div class='state'>MT</div> 
                    <div class='state'>NE</div> 
                    <div class='state'>NV</div> 
                    <div class='state'>NH</div> 
                    <div class='state'>NJ</div> 
                    <div class='state'>NM</div> 
                    <div class='state'>NY</div> 
                    <div class='state'>NC</div> 
                    <div class='state'>ND</div> 
                    <div class='state'>OH</div> 
                    <div class='state'>OK</div> 
                    <div class='state'>OR</div> 
                    <div class='state'>PA</div> 
                    <div class='state'>RI</div> 
                    <div class='state'>SC</div> 
                    <div class='state'>SD</div> 
                    <div class='state'>TN</div> 
                    <div class='state'>TX</div> 
                    <div class='state'>UT</div> 
                    <div class='state'>VT</div> 
                    <div class='state'>VA</div> 
                    <div class='state'>WA</div> 
                    <div class='state'>WV</div> 
                    <div class='state'>WI</div> 
                    <div class='state'>WY</div>
                </div>
            
        </div>
    </div>
    <script src="./main.js"></script>
</body>
<script>

    function getGraph() {
        localStorage.getItem('graph')
    }

    function setGraphTrue() {
        localStorage.setItem('graph', 'true')
    }

    function setGraphFalse() {
        localStorage.setItem('graph', 'false');
    }

    function removeOnUnload() {
        window.addEventListener('unload', function () {
            let grph = document.querySelector('svg');

            while (grph.firstChild) {
                grph.removeChild(grph.firstChild)
            }
        });
        setGraphFalse()
    }

    function removeChildren() {
        let grph = document.querySelector('svg');
        let tooltip = document.querySelector('.tooltip')

        while (grph.firstChild) {
            grph.removeChild(grph.firstChild)
        }
        tooltip.remove()
    }
    
    function loadUSAData() {
        window.addEventListener('load', () => {
            getCountry();
        });
        setGraphTrue();
    }

   
    document.getElementById("scroll").addEventListener("scroll", function(){})

    if (document.querySelector('.state')) {
        [...document.querySelectorAll('.state')].forEach(function(stadt) {
            stadt.addEventListener('click', e => {
                e.preventDefault();
                removeChildren();
                getState(e.currentTarget.textContent)
            });

        })
        setGraphTrue();
    }

    if (getGraph()) {
        window.addEventListener('unload', function () {
            removeChildren();
        });
        setGraphFalse();
    } else {
        loadUSAData();
        setGraphTrue();
    }

    async function getState(state) {
        const api_url = `/graph/${state}`;
        const response = await fetch(api_url);
        const text = await response.text();
        graph(text);
    }

    async function getCountry() {
        const api_url = `/nation`;
        const response = await fetch(api_url);
        const text = await response.text();
        graph(text);
    }

    function graph(DATA) {
        const data = JSON.parse(DATA);

        let height = 800;
        let width = 1450;
        let margin = 200;

        function commasForNums(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function clenseDups(data) {
            const distinctVals = [];

            for (let index = 0; index < data.length; index++) {
                if (index !== 0 && secondsEpochToDate(data[index].seconds_since_Epoch) !== secondsEpochToDate(data[index - 1].seconds_since_Epoch)) {
                    distinctVals.push(data[index])
                };
            }
            return distinctVals;
        }

        const distinctValues = clenseDups(data);

        function secondsEpochToDate(seconds) {
            let d = new Date(seconds * 1000);
            let dt = d.toLocaleString();
            dt = dt.split(',')

            return dt[0]
        }

        if (!(document.querySelector('svg'))) {
            let svg = d3.select("#graph")
                .append('svg')
                .attr("viewBox", [0, 0, width, height]); 
        }

        let svg = d3.select('svg')

        d3.select('svg')
            .attr('height', height)
            .attr('width', width)

        svg.append('text')
            .attr('x', 50)
            .attr('y', 50)
            .attr('font-size', '30px')
            .text('Tested,Confirmed,Deaths')

        let xScale = d3.scaleBand().range([0, width - margin]).padding(0.09)
            .domain(distinctValues.map(time => secondsEpochToDate(time.seconds_since_Epoch)))
        // .domain(d3.range(data.length))

        // let xDates = d3.scaleBand().range([0, width - margin]).padding(0.2)
        //     .domain(data.map(time => secondsEpochToDate(time.seconds_since_Epoch)))

        let yScale = d3.scaleLinear().range([height - margin, 0])
            .domain([0, d3.max(distinctValues, function (dt) { return parseInt(dt.tested) })]) // figure out a linear scale for domain height

        let g = svg.append("g")
            .attr("transform", "translate(" + 100 + "," + 100 + ")")


        let xg = g.append("g")
            .attr("transform", "translate(-1," + (height - margin) + ")")
            .call(d3.axisBottom(xScale))
            .selectAll('text')
            .attr('dx', '-3.2em')
            .attr('dy', '.35em')
            .attr('transform', 'rotate(-70)')

        g.append("g")
            .call(d3.axisLeft(yScale))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "-7.1em")
            .attr("text-anchor", "end")
            .attr("stroke", "black")
            .text("Tests");

        let div = d3.select('body').append('div')
            .style('opacity', '0')
            .attr('class', 'tooltip')

        g.selectAll(".rect")
            .data(distinctValues)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function (distinctValues) { return xScale(secondsEpochToDate(distinctValues.seconds_since_Epoch)) })
            // .attr("x", function (data,i) { return xScale(i) })
            .attr("y", function (distinctValues) { return yScale(distinctValues.tested) })
            .attr("width", xScale.bandwidth())
            .attr("height", function (distinctValues) { return ((height - margin) - yScale(distinctValues.tested)) })
            .on('mouseover', function (d, i) {
                d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '.85')
                div.transition()
                    .duration('50')
                    .style('opacity', '1')
                div.html('tested cases: ' + commasForNums(distinctValues[i].tested) + '<br>positive cases: ' +
                    commasForNums(distinctValues[i].positive) + '<br>resulting deaths: ' +
                    commasForNums(distinctValues[i].deaths))
                    .style('left', (d3.event.clientX - 13) + 'px')
                    .style('top', (d3.event.clientY - 20) + 'px')
            })
            .on('mouseout', function (d, i) {
                d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '1')
                div.transition()
                    .duration('50')
                    .style('opacity', '0')
            });
    }
</script>
</html>