<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    <script src="https://unpkg.com/regenerator-runtime@0.13.1/runtime.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <link rel="stylesheet" href="./main.css" />
    <title>Document</title>
</head>

<body>
    <div id='graph-bckgrnd'>
        <div id='graph'>
            <img id='covid-19' src='/images/23311.png'>
            <div id='scroll'>
                <div class='state'>AL</div>
                <div class='state'>AK</div> 
                <div class='state'>AZ</div> 
                <div class='state'>AR</div>
                <div class='state'>CA</div> 
                <div class='state'>CO</div> 
                <div class='state'>CT</div> 
                <div class='state'>DE</div> 
                <div class='state'>FL</div> 
                <div class='state'>GA</div> 
                <div class='state'>HI</div> 
                <div class='state'>ID</div> 
                <div class='state'>IL</div> 
                <div class='state'>IN</div> 
                <div class='state'>IA</div> 
                <div class='state'>KS</div> 
                <div class='state'>KY</div> 
                <div class='state'>LA</div> 
                <div class='state'>ME</div> 
                <div class='state'>MD</div> 
                <div class='state'>MA</div> 
                <div class='state'>MI</div> 
                <div class='state'>MN</div> 
                <div class='state'>MS</div> 
                <div class='state'>MO</div> 
                <div class='state'>MT</div> 
                <div class='state'>NE</div> 
                <div class='state'>NV</div> 
                <div class='state'>NH</div> 
                <div class='state'>NJ</div> 
                <div class='state'>NM</div> 
                <div class='state'>NY</div> 
                <div class='state'>NC</div> 
                <div class='state'>ND</div> 
                <div class='state'>OH</div> 
                <div class='state'>OK</div> 
                <div class='state'>OR</div> 
                <div class='state'>PA</div> 
                <div class='state'>RI</div> 
                <div class='state'>SC</div> 
                <div class='state'>SD</div> 
                <div class='state'>TN</div> 
                <div class='state'>TX</div> 
                <div class='state'>UT</div> 
                <div class='state'>VT</div> 
                <div class='state'>VA</div> 
                <div class='state'>WA</div> 
                <div class='state'>WV</div> 
                <div class='state'>WI</div> 
                <div class='state'>WY</div>
            </div>
        </div>
    </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <script src="./main.js"></script>
</body>
<script>

    let height = 800;
    let width = 1450;
    let margin = 200;

    if (!(document.querySelector('svg'))) {
        let svg = d3.select("#graph")
            .append('svg')
            .attr("viewBox", [0, 0, width, height]) 
    }
    
    let svg = d3.select('svg')
        .attr('height', height)
        .attr('width', width)
    
    let xScale = d3.scaleBand().range([0, width - margin]).padding(0.09)
    let yScale = d3.scaleLinear().range([height - margin, 0])
        
    function commasForNums(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    function secondsEpochToDate(seconds) {
        let d = new Date(seconds * 1000);
        let dt = d.toLocaleString();
        dt = dt.split(',')
        
        return dt[0]
    }
    
    let div = d3.select('body').append('div')
        .style('opacity', '0')
        .attr('class', 'tooltip')
        
    function graph(datum) {
        let data = JSON.parse(datum)

        function clenseDups(data) {
            const distinctVals = [];
            
            for (let index = 0; index < data.length; index++) {
                if (index !== 0 && secondsEpochToDate(data[index].seconds_since_Epoch) !== secondsEpochToDate(data[index - 1].seconds_since_Epoch)) {
                    distinctVals.push(data[index])
                };
            }
            return distinctVals;
        }

        function caseFatalityRate(data) {
            let totalPositive = 0;
            let totalDeaths = 0;
            
            totalPositive = parseInt(data[data.length-1].positive);
            totalDeaths = parseInt(data[data.length-1].deaths);
            
            return ((totalDeaths / totalPositive)*100).toFixed(2)
        }

        if (!(document.querySelector('.title'))) {
            svg.append('text')
                .attr('class','title')
                .attr('x', 50)
                .attr('y', 50)
                .attr('font-size', '30px')
                .text('Coronavirus Cases')

        } 
        
        if (!(document.querySelector('.axistitle'))) {
            svg.append('text')
                .attr('class','axistitle')
                .attr('x', 25)
                .attr('y', 100)
                .attr('font-size', '15px')
                .text('Tests')
        }

        if (!(document.querySelector('.headers'))) {
            svg.append('text')
                .attr('class', 'headers')
                .attr('x', 950)
                .attr('y', 45)
                .attr('font-size','30px')
                .text(`Case Fatality Rate:`)
        }

        svg.append('text')
            .attr('class', 'rate')
            .attr('x', 1185)
            .attr('y', 45)
            .attr('font-size', '30px')
            .text(`${caseFatalityRate(data)}%`)


        const distinctValues = clenseDups(data);

        xScale.domain(distinctValues.map(time => secondsEpochToDate(time.seconds_since_Epoch)))
        yScale.domain([0, d3.max(distinctValues, function (dt) { return parseInt(dt.tested) })]) 

        if (!(document.querySelector('#anchor'))) {
            svg.append("g")
                .attr("transform", "translate(" + 100 + "," + 100 + ")")
                .attr('id','anchor')
        } 
        
        let g = d3.select("#anchor")
            
        if (!(document.querySelector('#xtick'))) {
            g.append("g")
                .attr('id','xtick')
                .attr("transform", "translate(-1," + (height - margin) + ")")
                .transition().duration(2000)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('dx', '-3.2em')
                .attr('dy', '.35em')
                .attr('transform', 'rotate(-70)')
        } 

        let xg = g.select("#xtick")
            .attr("transform", "translate(-1," + (height - margin) + ")")
            .transition().duration(2000)
            .call(d3.axisBottom(xScale))
            .selectAll('text')
            .attr('dx', '-3.2em')
            .attr('dy', '.35em')
            .attr('transform', 'rotate(-70)')
    
        if (!(document.querySelector('#ytick'))) {
            g.append("g")
                .attr('id','ytick')
                .transition().duration(2000)
                .call(d3.axisLeft(yScale))
                .selectAll("text")
                .attr("transform", "rotate(0)")
        } 

        let yg = g.select("#ytick")
            .attr('id', 'ytick')
            .transition().duration(2000)
            .call(d3.axisLeft(yScale))
            .selectAll("text")
            .attr("transform", "rotate(0)")
        
            
        let rectangles = g.selectAll(".rect")
            .data(distinctValues)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("width", xScale.bandwidth())
            .attr("x", function (distinctValues) { return xScale(secondsEpochToDate(distinctValues.seconds_since_Epoch)) })
            .attr('height','0')
            .attr('y', function(d) { return yScale(0) })
            
        rectangles.transition()
            .duration(1500)
            .attr("y", function (distinctValues) { return yScale(distinctValues.tested) })
            .attr("height", function (distinctValues) { return ((height - margin) - yScale(distinctValues.tested)) })
            
        rectangles.on('mouseover', function (d, i) {
            d3.select(this).transition()
                .duration('50')
                .attr('opacity', '.85')
            div.transition()
                .duration('50')
                .style('opacity', '1')
            div.html('date: ' + secondsEpochToDate(distinctValues[i].seconds_since_Epoch) + 
                '<br>tested cases: ' + commasForNums(distinctValues[i].tested) +
                '<br>positive cases: ' + commasForNums(distinctValues[i].positive) + 
                '<br>resulting deaths: ' + commasForNums(distinctValues[i].deaths))
                .style('left', (d3.event.clientX - 13) + 'px')
                .style('top', (d3.event.clientY - 60) + 'px')
            })
            .on('mouseout', function (d, i) {
                d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '1')
                div.transition()
                    .duration('50')
                    .style('opacity', '0')
            });
    }

    function transitionDown() {
        let g = d3.select('#anchor')
        let rectangles = g.selectAll(".bar")
            
        rectangles.transition()
            .duration(1000)
            .attr('y', function (d) { return yScale(0) })
            .attr('height', '0')
    }

    function makeAMap(state) {
        let stadt = state;
        let width1 = 960;
        let height1 = 600;

        if (!(document.querySelector('svg'))) {
            let svg1 = d3.select("#graph")
                .append('svg')
        }

        let svg1 = d3.select('svg')
            
        const projection = d3.geoAlbersUsa().scale(500).translate([width1 / 3, height1 / 2.9])

        const path = d3.geoPath().projection(projection)

        if (!(document.querySelector('#MapG'))) {
            svg1.append("g")
                .attr('id','MapG')
        }

        let g = d3.select('#MapG')

        queue()
            .defer(d3.json, 'us.json')
            .await(makeMap);

        function makeMap(error, states) {
            if (!(document.querySelector('#states'))) {
                g.append("g")
                    .attr("id", "states")
                    .selectAll("path")
                    .data(topojson.feature(states, states.objects.usStates).features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", "state")
            }
            
            g.append("path")
                .datum(topojson.mesh(states, states.objects.usStates, function (a, b) { return a.properties.STATE_ABBR === stadt || b.properties.STATE_ABBR === stadt; }))
                .attr("id", "state-borders")
                .attr("d", path);
        
        }
    }

    

</script>
</html>